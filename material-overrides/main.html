{% extends "base.html" %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ 'assets/stylesheets/kluster.css' | url }}" />
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500&display=swap"
    rel="stylesheet"
  />
{% endblock %}

{% block site_meta %}
  {{ super() }}
  {% if page and page.meta and page.meta.keywords %}
    <meta name="keywords" content="{{ page.meta.keywords }}" />
  {% endif %}
{% endblock %}

{%- block htmltitle -%}
  {%- if page.is_homepage -%}
    <title>Documentation for kluster.ai</title>
  {%- elif page and page.meta and page.meta.title -%}
    <title>{{ page.meta.title }} | {{ config.site_name }}</title>
  {%- elif page and page.title and not page.is_homepage -%}
    <title>{{ page.title }} | {{ config.site_name }}</title>
  {%- else -%}
    <title>{{ config.site_name }}</title>
  {%- endif -%}
{%- endblock -%}

{% block libs %}
  <script>
    document.documentElement.classList.add("js-loading");

    (() => {
      const BREAKPOINT_EM = 76.25;
      const BREAKPOINT_PX = BREAKPOINT_EM * 16;

      function isLargeScreen() {
        return window.innerWidth >= BREAKPOINT_PX;
      }

      function getActiveSectionId() {
        const activeLink = document.querySelector(".md-nav__link--active");
        const section = activeLink?.closest(".nav__item--section");
        return section?.id || null;
      }

      function applySectionState(section, isExpanded) {
        const toggle = section.querySelector(":scope > .md-nav__toggle");
        const nav = section.querySelector(":scope > nav.md-nav");
        if (!toggle || !nav) return;

        toggle.checked = isExpanded;
        nav.setAttribute("aria-expanded", isExpanded);
        section.classList.toggle("expanded", isExpanded);
      }

      const sections = [];
      const toggles = new Map();

      function setupSection(section) {
        const id = section.id;
        if (!id) return;

        const toggle = section.querySelector(":scope > .md-nav__toggle");
        const nav = section.querySelector(":scope > nav.md-nav");
        if (!toggle || !nav) return;

        // Save toggle ref for later updates
        toggles.set(section, { toggle, nav });

        // Attach listener once
        if (!toggle.dataset.listenerAttached) {
          toggle.addEventListener("change", () => {
            const checked = toggle.checked;
            if (isLargeScreen()) {
              localStorage.setItem(id, checked);
            }
            applySectionState(section, checked);
          });
          toggle.dataset.listenerAttached = "true";
        }

        sections.push(section);
      }

      function applyInitialState() {
        const large = isLargeScreen();
        const activeId = getActiveSectionId();

        sections.forEach((section) => {
          const id = section.id;
          let isExpanded = false;

          if (large) {
            const saved = localStorage.getItem(id);
            isExpanded = saved === null ? true : saved === "true";

            // Always expand the active section, even if localStorage says false
            if (id === activeId) {
              isExpanded = true;
              localStorage.setItem(id, "true");
            }
          } else {
            // On small screens, only expand the active section
            isExpanded = id === activeId;
          }

          applySectionState(section, isExpanded);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Handle left navigation state
        document.querySelectorAll(".nav__item--section").forEach(setupSection);
        applyInitialState();

        document.documentElement.classList.remove("js-loading");
      });

      window.addEventListener("resize", () => {
        applyInitialState();
      });
    })();
  </script>

  {{ super() }}
{% endblock %}

{# {% block announce %}
  <p>
    üõ°Ô∏è Build with confidence‚ÄîVerify Code checks your AI-generated code for errors and security risks in real time. <a href="/verify/">See how it works</a>.
  </p>
{% endblock %} #}

{%- block container -%}
  <div class="md-content" data-md-component="content">
    {% set class = "index-page" if not page.content and not page.is_homepage %}
    <article class="md-content__inner md-typeset {{ class }}">
      {% block content %}
        {% include "partials/content.html" %}
      {% endblock %}
    </article>
    {% if "navigation.footer" in features %}
      {% if page.previous_page or page.next_page %}
        {% if page.meta and page.meta.hide %}
          {% set hidden = "hidden" if "footer" in page.meta.hide %}
        {% endif %}
        <nav class="md-footer__inner md-grid" aria-label="{{ lang.t('footer') }}" {{ hidden }}>
          {% if page.previous_page %}
            {% set direction = lang.t("footer.previous") %}
            <a href="{{ page.previous_page.url | url }}" 
              class="md-footer__link md-footer__link--prev" 
              aria-label="{{ direction }}: {{ page.previous_page.title | e }}"
            >
              <div class="md-footer__button md-icon">
                {% set icon = config.theme.icon.previous or "material/arrow-left" %}
                {% include ".icons/" ~ icon ~ ".svg" %}
              </div>
              <div class="md-footer__title">
                <span class="md-footer__direction">
                  {{ direction }}
                </span>
                <div class="md-ellipsis">
                  {{ page.previous_page.title }}
                </div>
              </div>
            </a>
          {% endif %}
          {% if page.next_page %}
            {% set direction = lang.t("footer.next") %}
            <a href="{{ page.next_page.url | url }}" 
              class="md-footer__link md-footer__link--next" 
              aria-label="{{ direction }}: {{ page.next_page.title | e }}"
            >
              <div class="md-footer__title">
                <span class="md-footer__direction">
                  {{ direction }}
                </span>
                <div class="md-ellipsis">
                  {{ page.next_page.title }}
                </div>
              </div>
              <div class="md-footer__button md-icon">
                {% set icon = config.theme.icon.next or "material/arrow-right" %}
                {% include ".icons/" ~ icon ~ ".svg" %}
              </div>
            </a>
          {% endif %}
        </nav>
      {% endif %}
    {% endif %}
  </div>
{%- endblock -%}

{% block scripts %}
  {{ super() }}
  <script>
    const link = document.querySelector("link[rel~='icon']");
    if (link) {
      const isDarkMode = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      isDarkMode
        ? (link.href = "{{ 'assets/images/favicon-dark-mode.png' | url }}")
        : (link.href = "{{ 'assets/images/favicon-light-mode.png' | url }}");
    }
  </script>

  <script>
    const content = document.querySelector(".md-content");
    const header = document.querySelector(".md-header");
    const footer = document.querySelector(".md-footer");

    function updateContentHeight() {
      if (content && header && footer) {
        const contentHeight = content.offsetHeight;
        const headerHeight = header.offsetHeight;
        const footerHeight = footer.offsetHeight;

        const pageHeight = headerHeight + footerHeight + contentHeight;
        const viewportHeight = window.innerHeight;

        if (pageHeight < viewportHeight) {
          content.style.minHeight = `${viewportHeight - headerHeight - footerHeight}px`;
        } else {
          content.style.minHeight = "auto";
        }
      }
    }

    updateContentHeight();
    window.addEventListener("resize", updateContentHeight);
  </script>
{% endblock %}