{% extends "base.html" %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ 'assets/stylesheets/kluster.css' | url }}" />
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@500&display=swap"
    rel="stylesheet"
  />
{% endblock %}

{% block site_meta %}
  {{ super() }}
  {% if page and page.meta and page.meta.keywords %}
    <meta name="keywords" content="{{ page.meta.keywords }}" />
  {% endif %}
{% endblock %}

{%- block htmltitle -%}
  {%- if page.is_homepage -%}
    <title>Documentation for kluster.ai</title>
  {%- elif page and page.meta and page.meta.title -%}
    <title>{{ page.meta.title }} | {{ config.site_name }}</title>
  {%- elif page and page.title and not page.is_homepage -%}
    <title>{{ page.title }} | {{ config.site_name }}</title>
  {%- else -%}
    <title>{{ config.site_name }}</title>
  {%- endif -%}
{%- endblock -%}

{% block libs %}
  {{ super() }}
  <script>
    // Anti-flicker
    document.documentElement.classList.add('js-loading');
  </script>
{% endblock %}

{% block announce %}
  <p>
    üõ°Ô∏è Build with confidence‚ÄîVerify Code checks your AI-generated code for errors and security risks in real time. <a href="/verify/code/overview/">See how it works</a>.
  </p>
{% endblock %}

{%- block container -%}
  <div class="md-content" data-md-component="content">
    {% set class = "index-page" if not page.content and not page.is_homepage %}
    <article class="md-content__inner md-typeset {{ class }}">
      {% block content %}
        {% include "partials/content.html" %}
      {% endblock %}
    </article>
  </div>
{%- endblock -%}

{% block scripts %}
  {{ super() }}
  <script>
    const link = document.querySelector("link[rel~='icon']");
    if (link) {
      const isDarkMode = window.matchMedia(
        '(prefers-color-scheme: dark)'
      ).matches;
      isDarkMode
        ? (link.href = "{{ 'assets/images/favicon-dark-mode.png' | url }}")
        : (link.href = "{{ 'assets/images/favicon-light-mode.png' | url }}");
    }
  </script>

  <script>
    // Persistent navigation state script
    (function () {
      const STORAGE_KEY = "kluster.navState";

      // Load saved navigation states
      function load() {
        try { 
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        }
        catch { 
          return {}; 
        }
      }

      // Save navigation states
      function save(state) {
        try { 
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }
        catch {}
      }

      // Apply saved states to navigation toggles
      function applyOnce() {
        const closed = load();
        const toggles = document.querySelectorAll('.md-nav__toggle.md-toggle[id]');
        
        toggles.forEach(input => {
          const shouldBeClosed = closed[input.id] === true;
          
          if (!shouldBeClosed && !input.checked) {
            input.checked = true;
          } else if (shouldBeClosed && input.checked) {
            input.checked = false;
          }
          
          if (shouldBeClosed) {
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
        
        setTimeout(() => {
          toggles.forEach(input => {
            if (closed[input.id] === true && input.checked) {
              input.checked = false;
              input.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        }, 50);
      }

      // Wire click event listeners
      function wire() {
        const closed = load();
        const allLabels = document.querySelectorAll('label[for]');
        
        allLabels.forEach((label) => {
          const inputId = label.getAttribute('for');
          const input = document.getElementById(inputId);
          
          if (!input || !input.classList.contains('md-nav__toggle')) return;
          
          label.addEventListener('click', (e) => {
            setTimeout(() => {
              const key = input.id;
              
              if (!input.checked) {
                closed[key] = true;
              } else {
                delete closed[key];
              }
              save(closed);
            }, 25);
          });
        });
      }

      // Initialize navigation state management
      function init() { 
        setTimeout(() => {
          applyOnce(); 
          wire(); 
          
          setTimeout(() => applyOnce(), 100);
          setTimeout(() => applyOnce(), 250);
          setTimeout(() => applyOnce(), 400);
          
          setTimeout(() => {
            document.documentElement.classList.remove('js-loading');
          }, 500);
        }, 150);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>
{% endblock %}